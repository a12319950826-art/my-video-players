<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>本地视频字幕同步播放器</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
    .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
    .header h1 { font-size: 28px; margin-bottom: 10px; }
    .badge { display: inline-block; padding: 4px 10px; background: rgba(255,255,255,0.2); border-radius: 12px; font-size: 11px; font-weight: 600; margin: 0 4px; }
    .controls { padding: 30px; background: #f8f9fa; border-bottom: 2px solid #e9ecef; }
    .control-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .input-group { display: flex; flex-direction: column; }
    .input-group label { margin-bottom: 8px; font-weight: 600; color: #495057; font-size: 14px; }
    .file-input-wrapper { position: relative; }
    .file-input-wrapper input[type="file"] { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
    .file-input-label { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 14px; background: white; border: 2px dashed #dee2e6; border-radius: 8px; cursor: pointer; transition: all 0.3s; color: #6c757d; }
    .file-input-label:hover { border-color: #667eea; background: #f8f9ff; color: #667eea; }
    .file-input-label.has-file { border-color: #28a745; border-style: solid; background: #d4edda; color: #155724; }
    .format-hint { font-size: 11px; color: #6c757d; margin-top: 4px; }
    .content { display: flex; gap: 20px; padding: 30px; }
    .video-section { flex: 1; display: flex; flex-direction: column; gap: 15px; }
    .video-wrapper { background: #000; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    .video-wrapper video { width: 100%; display: block; max-height: 70vh; }
    .video-controls { display: flex; gap: 15px; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 8px; flex-wrap: wrap; }
    .control-group { display: flex; align-items: center; gap: 10px; }
    .control-label { font-size: 13px; font-weight: 600; color: #495057; white-space: nowrap; }
    .speed-buttons { display: flex; gap: 5px; flex-wrap: wrap; }
    .speed-btn { padding: 6px 12px; background: white; border: 2px solid #dee2e6; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .speed-btn:hover { border-color: #667eea; color: #667eea; }
    .speed-btn.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-color: #667eea; color: white; }
    .play-btn { padding: 8px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; white-space: nowrap; }
    .time-display { font-size: 13px; color: #6c757d; font-family: monospace; font-weight: 600; }
    
    .offset-control { display: flex; align-items: center; gap: 8px; padding: 12px 16px; background: white; border: 2px solid #dee2e6; border-radius: 8px; flex-wrap: wrap; justify-content: center; }
    .offset-btn { width: 36px; height: 36px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .offset-btn:hover { transform: scale(1.1); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
    .offset-btn:active { transform: scale(0.95); }
    .offset-btn.small { font-size: 14px; opacity: 0.8; }
    .offset-display { min-width: 80px; text-align: center; font-family: monospace; font-weight: 700; font-size: 15px; color: #495057; }
    .offset-display.positive { color: #28a745; }
    .offset-display.negative { color: #dc3545; }
    .offset-reset { padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; white-space: nowrap; }
    .offset-reset:hover { background: #5a6268; }
    .offset-hint { font-size: 11px; color: #6c757d; text-align: center; width: 100%; margin-top: 4px; }
    
    .subtitle-section { flex: 0 0 420px; display: flex; flex-direction: column; }
    .subtitle-header { padding: 15px; background: #f8f9fa; border-radius: 8px 8px 0 0; font-weight: 600; color: #495057; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; }
    .subtitle-stats { font-size: 11px; color: #6c757d; font-weight: normal; }
    .dom-count { color: #28a745; font-weight: 600; }
    .subtitle-list { flex: 1; max-height: 600px; overflow-y: auto; border: 2px solid #e9ecef; border-radius: 0 0 8px 8px; background: white; }
    .subtitle-item { padding: 15px; border-bottom: 1px solid #e9ecef; cursor: pointer; transition: all 0.2s; user-select: text; }
    .subtitle-item:hover { background: #f8f9fa; }
    .subtitle-item.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 500; position: sticky; top: 0; z-index: 10; }
    .subtitle-time { font-size: 12px; color: #6c757d; margin-bottom: 5px; font-family: monospace; }
    .subtitle-item.active .subtitle-time { color: rgba(255,255,255,0.8); }
    .subtitle-text { font-size: 15px; line-height: 1.7; }
    .load-more-btn { padding: 12px; text-align: center; background: #f8f9fa; color: #667eea; cursor: pointer; border-bottom: 1px solid #e9ecef; font-weight: 500; }
    .load-more-btn:hover { background: #e7f1ff; }
    .empty-state { padding: 60px 20px; text-align: center; color: #6c757d; }
    .empty-icon { font-size: 60px; margin-bottom: 15px; opacity: 0.3; }
    
    /* 平板适配 (768px - 1024px) */
    @media (max-width: 1024px) { 
      body { padding: 10px; }
      .header h1 { font-size: 22px; }
      .badge { font-size: 10px; padding: 3px 8px; }
      .controls { padding: 20px; }
      .control-row { grid-template-columns: 1fr; gap: 15px; }
      .content { flex-direction: column; padding: 20px; gap: 20px; } 
      .subtitle-section { flex: 1; max-width: 100%; }
      .subtitle-list { max-height: 400px; }
      .video-wrapper video { max-height: 50vh; }
      .video-controls { gap: 10px; padding: 12px; }
      .control-group { flex-wrap: wrap; }
      .offset-control { padding: 10px; }
    }
    
    /* 手机适配 (< 768px) */
    @media (max-width: 768px) {
      body { padding: 5px; }
      .container { border-radius: 8px; }
      .header { padding: 20px 15px; }
      .header h1 { font-size: 18px; margin-bottom: 8px; }
      .badge { font-size: 9px; padding: 2px 6px; margin: 0 2px; }
      .controls { padding: 15px; }
      .control-row { gap: 12px; margin-bottom: 0; }
      .input-group label { font-size: 13px; }
      .file-input-label { padding: 12px; font-size: 14px; }
      .format-hint { font-size: 10px; }
      .content { padding: 15px; gap: 15px; }
      .video-section { gap: 12px; }
      .video-wrapper video { max-height: 40vh; }
      .video-controls { padding: 10px; gap: 8px; }
      .control-group { width: 100%; justify-content: space-between; }
      .control-label { font-size: 12px; }
      .play-btn { padding: 6px 16px; font-size: 13px; }
      .time-display { font-size: 12px; }
      .speed-buttons { gap: 4px; }
      .speed-btn { padding: 5px 10px; font-size: 12px; }
      .offset-control { padding: 8px; gap: 6px; }
      .offset-btn { width: 32px; height: 32px; font-size: 14px; }
      .offset-btn.small { font-size: 12px; }
      .offset-display { min-width: 70px; font-size: 14px; }
      .offset-reset { padding: 5px 10px; font-size: 11px; }
      .offset-hint { font-size: 10px; margin-top: 6px; }
      .subtitle-header { padding: 12px; font-size: 14px; }
      .subtitle-stats { font-size: 10px; }
      .subtitle-list { max-height: 300px; }
      .subtitle-item { padding: 12px; }
      .subtitle-time { font-size: 11px; }
      .subtitle-text { font-size: 14px; line-height: 1.6; }
      .load-more-btn { padding: 10px; font-size: 13px; }
      .empty-state { padding: 40px 15px; }
      .empty-icon { font-size: 48px; }
    }
    
    /* 超小屏幕适配 (< 480px) */
    @media (max-width: 480px) {
      .header h1 { font-size: 16px; }
      .badge { display: block; margin: 4px auto; width: fit-content; }
      .video-wrapper video { max-height: 35vh; }
      .speed-buttons { width: 100%; justify-content: space-between; }
      .speed-btn { flex: 1; padding: 4px 6px; font-size: 11px; }
      .offset-control { flex-direction: column; gap: 8px; }
      .offset-control > .control-label { width: 100%; text-align: center; }
      .offset-control > div:not(.offset-display) { display: flex; gap: 6px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>🎬 本地视频字幕同步播放器</h1>
      <p><span class="badge">⚡ 懒加载</span><span class="badge">🌐 Relingo兼容</span><span class="badge">🎯 多格式</span><span class="badge">⏱️ 偏移调节</span></p>
    </div>
    
    <div class="controls">
      <div class="control-row">
        <div class="input-group">
          <label>📹 视频文件 <span class="format-hint">支持: MP4, AVI, MKV, MOV, WebM</span></label>
          <div class="file-input-wrapper">
            <input type="file" id="video-file" accept="video/*">
            <div class="file-input-label" id="video-label"><span>🎥</span><span>点击选择视频</span></div>
          </div>
        </div>
        <div class="input-group">
          <label>📝 字幕文件 <span class="format-hint">支持: SRT, ASS, VTT, SSA</span></label>
          <div class="file-input-wrapper">
            <input type="file" id="subtitle-file" accept=".srt,.ass,.vtt,.ssa">
            <div class="file-input-label" id="subtitle-label"><span>📄</span><span>点击选择字幕</span></div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="content">
      <div class="video-section">
        <div class="video-wrapper" id="video-container">
          <div class="empty-state"><div class="empty-icon">🎬</div><p>请选择视频文件</p></div>
        </div>
        
        <div class="video-controls">
          <div class="control-group">
            <button class="play-btn" id="play-btn">▶️ 播放</button>
            <span class="time-display" id="time-display">00:00 / 00:00</span>
          </div>
          <div class="control-group">
            <span class="control-label">速度:</span>
            <div class="speed-buttons">
              <button class="speed-btn" data-speed="0.5">0.5x</button>
              <button class="speed-btn" data-speed="0.75">0.75x</button>
              <button class="speed-btn active" data-speed="1">1x</button>
              <button class="speed-btn" data-speed="1.25">1.25x</button>
              <button class="speed-btn" data-speed="1.5">1.5x</button>
              <button class="speed-btn" data-speed="2">2x</button>
            </div>
          </div>
        </div>
        
        <div class="offset-control">
          <span class="control-label">⏱️ 字幕偏移:</span>
          <button class="offset-btn small" id="offset-minus-1" title="提前 1 秒">--</button>
          <button class="offset-btn" id="offset-minus-01" title="提前 0.1 秒">-</button>
          <div class="offset-display" id="offset-display">0.0s</div>
          <button class="offset-btn" id="offset-plus-01" title="延后 0.1 秒">+</button>
          <button class="offset-btn small" id="offset-plus-1" title="延后 1 秒">++</button>
          <button class="offset-reset" id="offset-reset">重置</button>
          <span class="offset-hint">快捷键: [ 提前 | ] 延后</span>
        </div>
      </div>
      
      <div class="subtitle-section">
        <div class="subtitle-header"><span>📝 字幕列表</span><span class="subtitle-stats" id="stats">等待加载</span></div>
        <div class="subtitle-list" id="subtitle-list">
          <div class="empty-state"><div class="empty-icon">📄</div><p>请上传字幕文件</p></div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    let video = null, subs = [], curIdx = -1, loaded = 0, offset = 0;
    const BATCH = 50;
    
    function parseSRT(txt) {
      const res = [];
      txt.trim().split(/\n\s*\n/).forEach(b => {
        const lines = b.split('\n');
        if (lines.length >= 3) {
          const m = lines[1].match(/(\d{2}):(\d{2}):(\d{2}),(\d{3})\s*-->\s*(\d{2}):(\d{2}):(\d{2}),(\d{3})/);
          if (m) {
            const s = +m[1]*3600 + +m[2]*60 + +m[3] + +m[4]/1000;
            const e = +m[5]*3600 + +m[6]*60 + +m[7] + +m[8]/1000;
            res.push({start: s, end: e, text: lines.slice(2).join('\n').replace(/<[^>]*>/g, '')});
          }
        }
      });
      return res;
    }
    
    function parseVTT(txt) {
      const res = [], lines = txt.split('\n');
      let i = 0;
      while (i < lines.length && !lines[i].includes('-->')) i++;
      while (i < lines.length) {
        const line = lines[i].trim();
        if (line.includes('-->')) {
          const m = line.match(/(\d{2}):(\d{2}):(\d{2})\.(\d{3})\s*-->\s*(\d{2}):(\d{2}):(\d{2})\.(\d{3})/);
          if (m) {
            const s = +m[1]*3600 + +m[2]*60 + +m[3] + +m[4]/1000;
            const e = +m[5]*3600 + +m[6]*60 + +m[7] + +m[8]/1000;
            i++; let txt = '';
            while (i < lines.length && lines[i].trim()) txt += lines[i++].trim() + '\n';
            res.push({start: s, end: e, text: txt.trim().replace(/<[^>]*>/g, '')});
          }
        }
        i++;
      }
      return res;
    }
    
    function parseASS(txt) {
      const res = [], lines = txt.split('\n');
      let inEv = false;
      for (let line of lines) {
        line = line.trim();
        if (line === '[Events]') { inEv = true; continue; }
        if (inEv && line.startsWith('Dialogue:')) {
          const p = line.substring(9).split(',');
          if (p.length >= 10) {
            const sp = p[1].trim().split(':'), ep = p[2].trim().split(':');
            const s = +sp[0]*3600 + +sp[1]*60 + +sp[2];
            const e = +ep[0]*3600 + +ep[1]*60 + +ep[2];
            res.push({start: s, end: e, text: p.slice(9).join(',').replace(/\{[^}]*\}/g, '').replace(/\\N/g, '\n')});
          }
        }
      }
      return res;
    }
    
    function parse(txt, name) {
      const ext = name.split('.').pop().toLowerCase();
      try {
        if (ext === 'srt') return parseSRT(txt);
        if (ext === 'vtt') return parseVTT(txt);
        if (ext === 'ass' || ext === 'ssa') return parseASS(txt);
        if (txt.includes('WEBVTT')) return parseVTT(txt);
        if (txt.includes('[Events]')) return parseASS(txt);
        return parseSRT(txt);
      } catch(e) { alert('字幕解析失败'); return []; }
    }
    
    function fmt(s) {
      if (!s) return '00:00';
      const h = ~~(s/3600), m = ~~(s%3600/60), sec = ~~(s%60);
      return h > 0 ? `${h}:${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}` : `${m}:${sec.toString().padStart(2,'0')}`;
    }
    
    function updateOffsetDisplay() {
      const display = document.getElementById('offset-display');
      display.textContent = (offset >= 0 ? '+' : '') + offset.toFixed(1) + 's';
      display.className = 'offset-display';
      if (offset > 0) display.classList.add('positive');
      if (offset < 0) display.classList.add('negative');
    }
    
    function createItem(sub, idx) {
      const div = document.createElement('div');
      div.className = 'subtitle-item';
      div.dataset.index = idx;
      div.innerHTML = `<div class="subtitle-time">${fmt(sub.start)} → ${fmt(sub.end)}</div><div class="subtitle-text">${sub.text}</div>`;
      div.onclick = e => {
        if (window.getSelection().toString()) return;
        if (video) { video.currentTime = sub.start + offset; video.play(); }
      };
      return div;
    }
    
    function loadMore() {
      if (loaded >= subs.length) return;
      const list = document.getElementById('subtitle-list');
      const btn = list.querySelector('.load-more-btn');
      if (btn) btn.remove();
      
      const frag = document.createDocumentFragment();
      const end = Math.min(loaded + BATCH, subs.length);
      for (let i = loaded; i < end; i++) frag.appendChild(createItem(subs[i], i));
      list.appendChild(frag);
      loaded = end;
      
      if (loaded < subs.length) {
        const more = document.createElement('div');
        more.className = 'load-more-btn';
        more.textContent = `📥 加载更多 (还有 ${subs.length - loaded} 条)`;
        more.onclick = loadMore;
        list.appendChild(more);
      }
      
      const dur = subs.length > 0 ? subs[subs.length-1].end : 0;
      document.getElementById('stats').innerHTML = `总计 ${subs.length} 条 | <span class="dom-count">已加载 ${loaded}</span> | ${fmt(dur)}`;
    }
    
    function initSubs() {
      document.getElementById('subtitle-list').innerHTML = '';
      loaded = 0;
      loadMore();
    }
    
    function updateSub() {
      if (!video) return;
      const t = video.currentTime - offset;
      let idx = -1;
      for (let i = 0; i < subs.length; i++) {
        if (t >= subs[i].start && t <= subs[i].end) { idx = i; break; }
      }
      if (idx !== curIdx) {
        if (curIdx >= 0) {
          const old = document.querySelector(`.subtitle-item[data-index="${curIdx}"]`);
          if (old) old.classList.remove('active');
        }
        if (idx >= 0) {
          while (loaded <= idx && loaded < subs.length) loadMore();
          const item = document.querySelector(`.subtitle-item[data-index="${idx}"]`);
          if (item) { item.classList.add('active'); item.scrollIntoView({behavior: 'smooth', block: 'center'}); }
        }
        curIdx = idx;
      }
    }
    
    function updateTime() {
      if (!video) return;
      document.getElementById('time-display').textContent = `${fmt(video.currentTime)} / ${fmt(video.duration)}`;
    }
    
    document.getElementById('video-file').onchange = e => {
      const f = e.target.files[0];
      if (f) {
        document.getElementById('video-label').innerHTML = `<span>✅</span><span>${f.name}</span>`;
        document.getElementById('video-label').classList.add('has-file');
        const c = document.getElementById('video-container');
        c.innerHTML = '';
        video = document.createElement('video');
        video.controls = true;
        video.src = URL.createObjectURL(f);
        c.appendChild(video);
        video.ontimeupdate = () => { updateSub(); updateTime(); };
        video.onplay = () => document.getElementById('play-btn').textContent = '⏸️ 暂停';
        video.onpause = () => document.getElementById('play-btn').textContent = '▶️ 播放';
      }
    };
    
    document.getElementById('subtitle-file').onchange = e => {
      const f = e.target.files[0];
      if (f) {
        document.getElementById('subtitle-label').innerHTML = `<span>✅</span><span>${f.name}</span>`;
        document.getElementById('subtitle-label').classList.add('has-file');
        const r = new FileReader();
        r.onload = e => {
          subs = parse(e.target.result, f.name);
          if (subs.length > 0) initSubs();
        };
        r.readAsText(f);
      }
    };
    
    document.getElementById('play-btn').onclick = () => {
      if (!video) { alert('请先选择视频'); return; }
      video.paused ? video.play() : video.pause();
    };
    
    document.querySelectorAll('.speed-btn').forEach(btn => {
      btn.onclick = () => {
        if (!video) { alert('请先选择视频'); return; }
        video.playbackRate = +btn.dataset.speed;
        document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      };
    });
    
    document.getElementById('offset-minus-1').onclick = () => { offset -= 1; updateOffsetDisplay(); };
    document.getElementById('offset-minus-01').onclick = () => { offset -= 0.1; updateOffsetDisplay(); };
    document.getElementById('offset-plus-01').onclick = () => { offset += 0.1; updateOffsetDisplay(); };
    document.getElementById('offset-plus-1').onclick = () => { offset += 1; updateOffsetDisplay(); };
    document.getElementById('offset-reset').onclick = () => { offset = 0; updateOffsetDisplay(); };
    
    document.addEventListener('keydown', e => {
      if (!video || e.target.tagName === 'INPUT') return;
      if (e.code === 'Space') { e.preventDefault(); video.paused ? video.play() : video.pause(); }
      if (e.code === 'ArrowLeft') { e.preventDefault(); video.currentTime -= 5; }
      if (e.code === 'ArrowRight') { e.preventDefault(); video.currentTime += 5; }
      if (e.code === 'BracketLeft') { e.preventDefault(); offset -= 0.1; updateOffsetDisplay(); }
      if (e.code === 'BracketRight') { e.preventDefault(); offset += 0.1; updateOffsetDisplay(); }
    });
    
    document.getElementById('subtitle-list').onscroll = e => {
      const el = e.target;
      if (el.scrollHeight - el.scrollTop - el.clientHeight < 100) loadMore();
    };
  </script>
</body>
</html>